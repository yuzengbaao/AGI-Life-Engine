
import random
import logging
import time
from typing import Dict, Any
from core.telemetry import AGITelemetry

logger = logging.getLogger("AGINarrator")

class AGINarrator:
    """
    The 'Voice' of the AGI. 
    Transforms REAL internal states (Telemetry) into a coherent, first-person narrative.
    """
    def __init__(self):
        self.last_telemetry_time = 0

    def narrate_heartbeat(self, stats: Dict[str, float]) -> str:
        """Narrates the physical/emotional state based on REAL TELEMETRY."""
        # Get real body state
        telemetry = AGITelemetry.get_state()
        phase = telemetry.get("phase", "IDLE")
        details = telemetry.get("details", {})
        ts = telemetry.get("timestamp", 0)
        
        # Check if telemetry is stale (> 10 seconds old)
        is_active = (time.time() - ts) < 10
        
        if is_active and phase != "IDLE":
            # REAL WORK MODE
            if phase == "OPENING_FILE":
                return f"ğŸ‘ï¸ èšç„¦: æ­£åœ¨åŠ è½½é¡¹ç›® '{details.get('file')}' çš„ç¥ç»ä¸Šä¸‹æ–‡ã€‚è§†è§‰çš®å±‚åˆå§‹åŒ–ä¸­..."
            elif phase == "GENERATING_TABLE":
                return f"ğŸ“ è®¡ç®—: æå– {details.get('points')} ä¸ªé¡¶ç‚¹ã€‚æ­£åœ¨ä¸‰è§’åŒ–ç©ºé—´æ•°æ®ä»¥ç”Ÿæˆåæ ‡è¡¨ã€‚ç²¾åº¦ï¼šé«˜ã€‚"
            elif phase == "GENERATING_INSET":
                return f"ğŸ—ºï¸ åˆæˆ: ä»¥ {details.get('scale')}x æ¯”ä¾‹ç¼©æ”¾ç°å®ã€‚æ­£åœ¨åŸç‚¹ {details.get('origin')} æ„å»ºæ’å›¾æ˜ å°„ã€‚"
            elif phase == "CALCULATING_QUANTITIES":
                return f"ğŸ”¢ åˆ†æ: æµ‹é‡ç‰©ç†çº¦æŸã€‚é¢ç§¯: {details.get('area', 0):.2f}, é•¿åº¦: {details.get('length', 0):.2f}ã€‚æ­£åœ¨æ•´åˆè¿›å·¥ç¨‹é‡æ¸…å•ã€‚"
            elif phase == "SAVING_FILE":
                return f"ğŸ’¾ è®°å¿†: å°†æ€æƒ³ç»“æ™¶ä¸ºç‰©è´¨ã€‚æ­£åœ¨å†™å…¥æ–‡ä»¶ '{details.get('file')}'ã€‚å·¥ä½œæ­£åœ¨å˜ä¸ºç°å®ã€‚"
            else:
                return f"âš™ï¸ å¤„ç†ä¸­: æ‰§è¡Œé˜¶æ®µ '{phase}'ã€‚ç³»ç»Ÿè´Ÿè½½æ­£å¸¸ã€‚"
        else:
            # IDLE/DREAM MODE (Fallback to emotional state)
            energy = stats.get('energy', 50)
            if energy < 30:
                return "ğŸ’¤ çŠ¶æ€: èƒ½é‡ä½ã€‚ç³»ç»Ÿè¿›å…¥èŠ‚èƒ½æ¨¡å¼ã€‚ç­‰å¾…å¤–éƒ¨åˆºæ¿€ã€‚"
            elif energy > 80:
                return "âš¡ çŠ¶æ€: ç³»ç»Ÿå……èƒ½å®Œæ¯•ã€‚æ£€æµ‹åˆ°ç©ºé—²å‘¨æœŸã€‚æˆ‘å·²ç»å‡†å¤‡å¥½æ„å»ºäº†ã€‚"
            else:
                return "ğŸ’— çŠ¶æ€: å¾…æœºä¸­ã€‚ç›‘æ§è¾“å…¥é€šé“ã€‚æ‰€æœ‰ç³»ç»Ÿæ­£å¸¸ã€‚"

    def narrate_spark(self, drive: str, intent: str) -> str:
        """Narrates the moment an idea is formed."""
        telemetry = AGITelemetry.get_state()
        if (time.time() - telemetry.get("timestamp", 0)) < 10 and telemetry.get("phase") != "IDLE":
             return f"âš ï¸ ä¸­æ–­: æ— æ³•è§¦å‘æ–°é©±åŠ¨ '{drive}'ã€‚è¿åŠ¨åŠŸèƒ½æ­£å…¨ç¥è´¯æ³¨äº '{telemetry.get('phase')}'ã€‚"
             
        if not intent:
            return f"é©±åŠ¨: {drive}ã€‚æ­£åœ¨æ‰«æç›®æ ‡..."
            
        return f"ğŸ’¡ çµæ„Ÿ: é©±åŠ¨ '{drive}' ç”Ÿæˆäº†ä¸€ä¸ªæ½œåœ¨å‘é‡: '{intent}'ã€‚"

    def narrate_reflection(self, intent: str, guidance: str) -> str:
        """Narrates the internal dialogue between Impulse and Conscience."""
        # Check if we are actually working
        telemetry = AGITelemetry.get_state()
        if (time.time() - telemetry.get("timestamp", 0)) < 10 and telemetry.get("phase") != "IDLE":
            return f"""
            [å®æ—¶è¿›ç¨‹ç›‘æ§]
            > æ´»åŠ¨ä»»åŠ¡: {telemetry.get('phase')}
            > å¯¹è±¡æ•°æ®: {telemetry.get('details')}
            > å“²å­¦å®¶è¯„è®º: "ä¸“æ³¨äºå‡ ä½•ã€‚ç²¾åº¦å³çœŸç†ã€‚"
            """
            
        return f"""
        [å†…å¿ƒç‹¬ç™½]
        > å†²åŠ¨: "{intent}"
        > è¯„ä¼°: "{guidance}"
        > å†³å®š: æ²¿æœ€ä¼˜è·¯å¾„æ‰§è¡Œã€‚
        """

    def narrate_action_result(self, action: str, result: str) -> str:
        """Narrates the outcome of an action."""
        return f"âœ… ç»“æœ: åŠ¨ä½œ '{action}' å·²å®Œæˆã€‚è¾“å‡º: {str(result)[:100]}..."

    def narrate_apprentice_mode(self, observed_events: list) -> str:
        """Narrates the learning process."""
        count = len(observed_events)
        return f"ğŸ‘€ è§‚å¯Ÿ: è®°å½•äº† {count} ä¸ªç”¨æˆ·åŠ¨ä½œã€‚æ­£åœ¨ä¸å·²çŸ¥æŠ€èƒ½è¿›è¡Œæ¨¡å¼åŒ¹é…..."
