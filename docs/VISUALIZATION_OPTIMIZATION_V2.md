# AGI 系统可视化架构优化报告 (V2)

**日期**: 2025-12-29
**版本**: 2.0
**模块**: Visualization / Dashboard V2
**端口**: 8091

## 1. 优化背景与目标

在 AGI 系统的开发过程中，我们需要一个能够真实、实时反映系统内部组件拓扑连接状态的可视化界面。原有的可视化方案存在以下局限性：
- **状态闪烁**：基于单行日志的状态判断导致组件在“活跃”与“离线”之间频繁跳变。
- **连接判定脆弱**：缺乏对时间维度的考量，无法准确反映“数据流”的连续性。
- **局部视角**：未能从全局角度展示系统的健康度。

本次优化的目标是构建一个**抗噪、稳定且具备全局视野**的实时监控系统，明确拓扑连接的有效性。

## 2. 前后对比分析

### 2.1 数据获取机制

| 特性 | 优化前 (V1) | 优化后 (V2) | 评价 |
| :--- | :--- | :--- | :--- |
| **日志读取** | 仅读取最后一行 (`tail -n 1`) | 读取最近 50 条日志 (`tail -n 50`) | V2 能够捕获完整的上下文信息。 |
| **状态判定** | 瞬时状态（Snapshot） | 时间窗口聚合（Time Window Aggregation） | V2 消除了因系统分步执行导致的误报。 |
| **时间敏感度** | 极高（毫秒级跳变） | 平滑（60秒滑动窗口） | V2 更符合人类观察习惯，反映系统真实健康度。 |

### 2.2 拓扑连接有效性

| 特性 | 优化前 (V1) | 优化后 (V2) | 评价 |
| :--- | :--- | :--- | :--- |
| **连接定义** | 仅当两端组件在同一时刻活跃时视为连接 | 两端组件在时间窗口内均有活跃记录即视为连接 | V2 正确处理了异步/顺序执行的组件关系。 |
| **可视化反馈** | 静态线条 | 动态着色（活跃=高亮蓝，断开=暗红） | V2 提供了直观的视觉反馈。 |

## 3. 技术实现细节

### 3.1 后端聚合算法 (`dashboard_server_v2.py`)

为了避免**局部最优解**（即只关注当前帧），我们引入了基于时间窗口的聚合算法：

```python
# 核心逻辑伪代码
def get_topology_status():
    entries = get_recent_log_entries(50)
    current_time = entries[0].timestamp
    
    # 聚合：遍历最近日志，更新每个组件的 last_active_timestamp
    for entry in entries:
        update_component_last_active(entry)
        
    # 判定：如果 (current_time - last_active) < 60s，则标记为 Active
    # 这种设计避免了因单步执行（如只在 Step 1 活跃，Step 2 不活跃）导致的状态丢失
```

### 3.2 前端实时反馈 (`architecture_topology_v2.html`)

- **轮询机制**：每 3 秒请求一次 `/api/topology`，获取聚合后的状态。
- **视觉映射**：
  - **节点**：根据 `active` 状态改变亮度。
  - **连线**：仅当 `source` 和 `target` 均为 `active` 时，连线才显示为高亮，代表“通路畅通”。
- **用户提示**：明确标注“基于最近60秒活动聚合”，增加透明度。

## 4. 全局视野与防过拟合

### 4.1 避免局部最优解
在系统设计中，如果仅针对“让灯亮起来”进行硬编码（例如强制返回 True），就是典型的局部最优解。我们选择**基于真实日志的时间窗口分析**，这是一种通用的、鲁棒的解决方案：
- 无论系统运行快慢，只要在窗口期内有活动，状态就是准确的。
- 即使日志格式微调，只要核心字段（timestamp, component_id）存在，逻辑依然有效。

### 4.2 避免过拟合
我们没有为特定的组件编写特殊的检测逻辑（例如“如果是 Planner 且 step=1 则...”），而是采用了统一的**活跃度检测模型**：
- 所有组件一视同仁，基于日志产出判定活跃。
- 这种通用模型具有更好的扩展性，未来新增组件只需注册名称即可，无需修改核心检测逻辑。

## 5. 结论

本次优化成功构建了一个**高可信度**的 AGI 系统架构可视化界面。它不仅解决了“断裂”显示的误报问题，更重要的是建立了一套**基于数据流**的健康度评估标准。

通过 8091 端口的实时监控，开发者现在可以清晰地看到：
1. **组件是否在线**（基于 60s 心跳）。
2. **数据通路是否畅通**（拓扑连接有效性）。
3. **系统整体运行节奏**（通过观察活跃状态的传递）。

这为后续的系统调试、性能优化和架构演进提供了坚实的可观测性基础。
