# AGI 拓扑与代码对齐｜单一真相版（2026-01-10）

本文件是"拓扑图（可视化）↔ 代码（可运行实现）"对齐的唯一权威描述，用于替代/收敛同日生成的多份报告口径不一致问题。

---

## 0. 权威来源（Single Source of Truth）

以本文件为准时，数据来源按优先级排序：

1. 拓扑定义（结构真相）
   - `D:\TRAE_PROJECT\AGI\workspace\system_topology_3d.html`
2. 运行实现（执行真相）
   - `D:\TRAE_PROJECT\AGI\AGI_Life_Engine.py`
   - `D:\TRAE_PROJECT\AGI\tool_execution_bridge.py`
   - `D:\TRAE_PROJECT\AGI\agi_component_coordinator.py`
   - `D:\TRAE_PROJECT\AGI\security_framework.py`
   - `D:\TRAE_PROJECT\AGI\core\insight_evaluator.py`
3. 验证与测试（可复核真相）
   - `D:\TRAE_PROJECT\AGI\tests\test_enhanced_validator.py`

---

## 1. 拓扑快照（以 system_topology_3d.html 为准）

- 节点数：39
- 连接数：67
- 连接类型：data / control / event

备注：此前存在"37 节点 / 64 连接"的旧口径，已过期，不可再用于验收。

---

## 2. 对齐判定标准（验收口径）

一条拓扑连接被认定"已实现"，需满足其类型语义：

- data：存在明确的数据传递/引用关系（例如 `self.a = A()` 被 `B(a)` 使用、或函数入参/返回值流转）
- control：存在明确的控制驱动关系（例如 A 触发 B 的行为：调用/调度/启动/停止）
- event：存在事件发布/订阅（publish/subscribe）或回调机制，且链路可追踪到"从 source 产生事件 → target 接收处理"

若仅存在"概念关联/注释描述/文件同处一层"，不算实现。

---

## 3. 当前关键对齐状态（按断裂优先级）

### 3.1 已落地（关键断裂已补齐）

- ComponentCoordinator 已在 Engine 初始化
  - 代码位置：`AGI_Life_Engine.__init__` 中 `self.component_coordinator = ComponentCoordinator(agi_system=self)`（并注册 security）
- SecurityManager 已提升为 Engine 系统级组件
  - 代码位置：`AGI_Life_Engine.__init__` 中 `self.security_manager = SecurityManager()`
- GoalManager 的文件路径映射已修正为 `core/goal_system.py`
  - 拓扑位置：`system_topology_3d.html` Layer 6 节点 `GoalManager` 指向 `core/goal_system.py`

### 3.2 已实现但仍存在"语义偏差/未贯通"（需要明确写入验收结论）

- InsightEvaluator → AGI_Life_Engine
  - 拓扑当前标注为 data（并注释"轮询，而非事件推送"）
  - 代码当前新增了"事件回调能力"（`generate_report(... emit_event=True)` 可触发回调），但 Engine 侧尚未把该回调绑定到 event_bus 或 coordinator，因此：
    - 若按"事件回流"验收：仍未完全贯通（Engine 未接收）
    - 若按"轮询 data"验收：可视为已对齐（Engine 可轮询 report）

- ToolExecutionBridge / ToolFactory / BridgeAutoRepair → ComponentCoordinator
  - 代码侧已建立 Coordinator 引用，并在工具执行/修复链路中发布事件（用于拓扑 event/data 的最小闭环）。
  - 其中 SecurityManager 的实例归属已明确为系统级（Engine 持有），Bridge 复用同一实例，避免双实例分叉。

### 3.3 概念性连接（不建议强行实现，应在拓扑/验收中降级为"设计意图"）

- ImmutableCore → SecurityManager
- ImmutableCore → CriticAgent

理由：ImmutableCore 当前是价值/宪法数据承载，缺少可执行的"控制面 API"；若要实现，应通过单独的"Policy/Guard 层"桥接，而不是直接让数据类调用安全组件。

---

## 4. 阻塞性缺陷（必须先修复，否则"验收通过"无效）

### 4.1 Engine 启动崩溃：_build_system_dependency_graph 访问未初始化属性 ✅ 已修复

现象（已复现）：
- `AttributeError: 'AGI_Life_Engine' object has no attribute 'motivation'`

原因：
- `_build_system_dependency_graph()` 在 `__init__` 的早期调用，但内部直接访问 `self.motivation`，而 `self.motivation` 在后续才初始化。

修复状态：**✅ 已修复 (2026-01-10)**
- 已改为 `getattr(self, 'motivation', None)` 等防御式写法
- 验证命令：`python -c "from AGI_Life_Engine import AGI_Life_Engine; print('OK')"` → 输出 `Engine import OK`

### 4.2 InsightEvaluator 初始化逻辑被破坏 ✅ 已修复

现状风险：
- `core/insight_evaluator.py` 中 `self.metrics / self.session_metrics` 的初始化若被放入 `set_event_callback()`，而 Engine 未调用该方法，则 `record_call()` 会崩溃。

修复状态：**✅ 已修复 (2026-01-10)**
- `self.metrics` 与 `self.session_metrics` 已在 `InsightEvaluator.__init__` 内完成初始化
- `set_event_callback()` 仅负责注入回调
- 验证命令：`python -c "from core.insight_evaluator import InsightEvaluator; e=InsightEvaluator(); e.record_call('x', True, 0.01); print('OK')"` → 输出 `OK`

---

## 5. 推荐的最终一致性策略（避免"图上有/代码里无"反复出现）

### 策略 A（优先）：以代码现实为准，调整拓扑语义
适用：当前阶段强调"系统可跑"。

- 保持 `InsightEvaluator -> AGI_Life_Engine` 为 data（轮询）
- 将 `SecurityManager` 在拓扑描述中标注为"系统级（Engine 持有），Bridge 可复用"
- 将 `ToolExecutionBridge -> ComponentCoordinator` 等边标注为"待贯通"，不要写成已实现

### 策略 B：以拓扑设计为准，补齐代码贯通
适用：准备进入"工具路由统一治理"。

最小闭环建议：
- Engine 为 `InsightEvaluator` 注入 event callback，并把回调发布到 `LifeEngineEventBus` 或 `ComponentCoordinator.publish`
- ToolExecutionBridge 使用 `agi_system.component_coordinator` 执行安全/路由（而不是内部私有 SecurityManager）

---

## 6. 验收命令（Windows / PowerShell）

说明：验收必须先通过"阻塞性缺陷修复"，再运行以下命令。

### 6.1 语法检查
```powershell
cd D:\TRAE_PROJECT\AGI
python -m py_compile AGI_Life_Engine.py core\insight_evaluator.py
```

### 6.2 最小启动验证（若依赖齐全）
```powershell
cd D:\TRAE_PROJECT\AGI
python AGI_Life_Engine.py
```

### 6.3 轻量级单元验证（不启动完整引擎）
```powershell
cd D:\TRAE_PROJECT\AGI
python -c "from core.insight_evaluator import InsightEvaluator; e=InsightEvaluator(); e.record_call('t', True, 0.01); print('InsightEvaluator OK')"
```

---

## 7. 文档收敛说明（Deprecated 列表）

以下文档不再作为验收依据，仅保留为历史记录/线索来源：

- `docs\AGI_拓扑代码对齐修复验收报告_20260110.md`（包含与真实代码不一致的片段，且在阻塞性缺陷存在时仍宣称"验收通过"）
- `docs\AGI_3D拓扑架构对比分析报告_20260110.md`（节点/连接统计与当前拓扑不一致，并包含已被拓扑/代码推翻的结论）
- `docs\AGI_拓扑图连接验证清单_20260110.md`（统计口径正确，但已被后续代码变更部分过期；需在修复后重新生成）
- `docs\AGI_伪代码检测验证增强_集成文档.md`（设计与测试可参考，但日期较早，需以当前代码为准校订示例）

---

## 8. 结论（本版验收门槛）

当且仅当满足以下条件，才允许对外宣称"拓扑-代码对齐通过"：

1. ✅ Engine 能完成初始化并进入主循环（不因依赖图构建崩溃）
2. ✅ InsightEvaluator 在 Engine 路径中可被调用（不会因未调用 set_event_callback 而崩）
3. ⚠️ 对外宣称的每条关键连接（尤其 event）均能给出"可复现链路证据"（部分待补齐）

**当前状态**: 前2项已通过验证，第3项中的 event 类连接仍有5条待贯通（见 §3.2/§3.3）

---

## 9. 自动复核机制

### 9.1 复核脚本

**文件**: `scripts/verify_topology_links.py`

功能：
- 从 `system_topology_3d.html` 自动提取 67 条边
- 逐条搜索代码证据（正则匹配 + 预定义证据映射）
- 生成验证报告 `docs/AGI_拓扑连接验证结果_自动生成.md`

### 9.2 运行命令

```powershell
cd D:\TRAE_PROJECT\AGI
python scripts/verify_topology_links.py
```

### 9.3 最新自动复核结果（2026-01-10）

| 状态 | 数量 |
|------|------|
| ✅已实现 | 22 |
| ⚠️部分实现 | 31 |
| ⚠️待验证 | 12 |
| 🔵概念性 | 2 |
| **总计** | 67 |
- V-I-E Loop 关键连接 (4条)
- ComponentCoordinator/SecurityManager 系统级集成 (4条)

**未实现/待贯通 (6条)**:
1. `InsightValidator → InsightIntegrator` - 需完善证据搜索模式
2. `InsightIntegrator → BiologicalMemory` - 需完善证据搜索模式
3. `ComponentCoordinator → SecurityManager` - Coordinator未引用SM
4. `ToolExecutionBridge → ComponentCoordinator` - Bridge未接入Coordinator
5. `ToolFactory → ComponentCoordinator` - Factory未接入Coordinator
6. `BridgeAutoRepair → ComponentCoordinator` - AutoRepair未发布事件

**概念性连接 (2条)**:
- `ImmutableCore → SecurityManager` - frozen dataclass设计
- `ImmutableCore → CriticAgent` - frozen dataclass设计

---

*本文件为AGI拓扑与代码对齐的单一事实来源，后续更新以此为准*
