桌面自动化宏执行系统设计规范

1. 引言

本规范旨在明确桌面自动化宏执行系统的设计原则、架构组成、核心模块交互机制及技术实现要求。系统以core/desktop_automation.py中的宏操作框架为基础，结合vision_observer.py提供的视觉反馈能力，构建具备高可靠性、强适应性和智能决策能力的自动化执行体系。通过统一设计标准，确保系统在不同环境下的稳定运行与可维护性。

2. 系统总体架构

桌面自动化宏执行系统采用分层架构设计，分为以下四个层级：

- 操作指令层：负责宏命令的定义、解析与调度，来源于用户配置或脚本输入。
- 宏执行引擎层：基于desktop_automation.py实现，承担动作序列的组织、执行控制与异常处理。
- 视觉感知层：由vision_observer.py提供支持，实时捕获屏幕图像并识别关键界面元素状态。
- 决策反馈层：融合视觉信息与预设逻辑，动态调整宏执行路径，实现闭环控制。

各层之间通过标准化接口通信，保证模块解耦和功能扩展性。

3. 宏操作框架设计（基于 desktop_automation.py）

3.1 动作类型定义

宏操作框架支持以下基本动作类型：
- 鼠标操作：移动、点击（单击、双击、右键）、拖拽
- 键盘操作：按键输入、组合键触发、文本粘贴
- 窗口控制：窗口激活、最小化、最大化、关闭
- 延时控制：固定延时、条件等待
- 流程控制：跳转、循环、条件分支

所有动作应封装为可序列化的对象，便于存储、复用与调试。

3.2 宏指令结构

每个宏由一个指令列表构成，每条指令包含：
- 指令ID：唯一标识符
- 操作类型：枚举值表示具体行为
- 参数集合：JSON格式，包含坐标、键码、等待时间等
- 执行条件：可选，用于条件执行判断
- 超时设置：最大等待执行时间
- 重试策略：失败后是否重试及次数限制

3.3 执行流程管理

宏执行引擎需支持：
- 同步/异步执行模式切换
- 暂停、恢复、终止功能
- 执行日志记录（时间戳、动作类型、结果状态）
- 异常捕获与回滚机制（如窗口丢失时的重试逻辑）

4. 视觉反馈机制集成（基于 vision_observer.py）

4.1 视觉观察器职责

vision_observer.py 提供以下核心功能：
- 屏幕截图采集：按需或周期性获取当前桌面图像
- 图像模板匹配：识别预存图像片段在屏幕中的位置
- OCR文字识别：提取界面上可见文本内容
- 区域状态监测：监控指定区域颜色变化或动态特征
- 目标存在性检测：判断某个UI元素是否出现/消失

4.2 反馈数据格式

视觉反馈输出应标准化为结构化数据，包括：
- 时间戳
- 检测目标名称
- 是否检测到（布尔值）
- 匹配位置（x, y, width, height）
- 置信度评分（0~1）
- 附加信息（如OCR识别文本）

4.3 触发机制

视觉反馈可通过以下方式触发：
- 主动查询：宏执行过程中显式调用观察方法
- 被动监听：注册回调函数，在特定视觉事件发生时通知宏引擎
- 条件轮询：在等待某状态时持续检测直至满足或超时

5. 宏执行与视觉反馈的协同机制

5.1 条件等待与状态验证

宏执行中涉及依赖界面响应的操作时，必须引入视觉验证环节。例如：
- 点击“保存”按钮后，等待“保存成功”提示出现
- 启动程序后，等待主窗口加载完成

此类场景应使用“等待直到视觉条件满足”指令，结合vision_observer进行轮询检测。

5.2 自适应坐标定位

传统绝对坐标操作易受分辨率或窗口偏移影响。系统应优先采用基于图像识别的相对定位策略：
- 以某一稳定UI元素为参考锚点
- 计算目标操作位置相对于锚点的偏移量
- 实际执行时先识别锚点，再推导出操作坐标

5.3 动态路径调整

当视觉反馈表明预期界面状态未达成时，宏引擎应具备路径修正能力：
- 连续多次未识别到目标时，尝试替代方案（如重新登录）
- 检测到错误弹窗时，自动执行关闭并返回上一状态
- 根据OCR识别内容决定下一步操作分支

6. 错误处理与鲁棒性设计

6.1 分级异常分类

定义三类异常：
- 轻量级异常：短暂识别失败，允许重试
- 中等级异常：界面状态偏离预期，需补偿操作
- 严重异常：核心组件不可用，需中断并报警

6.2 恢复策略

系统应内置恢复机制：
- 自动重试：对可恢复动作设置重试间隔与上限
- 状态回退：回到上一个已知正确状态重新开始
- 用户干预提示：严重异常时暂停并请求人工介入

6.3 日志与追踪

所有执行过程必须记录详细日志，包括：
- 宏启动/结束时间
- 每一步动作及其参数
- 视觉检测结果截图（可选）
- 异常堆栈信息
- 决策依据说明

日志文件应支持导出与离线分析。

7. 配置与可扩展性要求

7.1 配置文件格式

宏定义与视觉模板应采用标准格式存储：
- 宏指令：JSON或YAML格式，支持注释与版本标记
- 图像模板：PNG格式，附带元数据（应用名、用途、采集环境）

7.2 插件化设计

鼓励将特定业务逻辑封装为插件模块，如：
- 特定软件的操作封装包
- 行业专用OCR词典
- 第三方API集成接口

8. 性能与资源管理

8.1 资源占用控制

视觉采样频率不得过高，避免CPU/GPU过载：
- 默认截图间隔不低于200ms
- 多任务并行时动态降低采样率
- 支持后台运行优化模式

8.2 缓存机制

建立图像模板缓存池，避免重复加载与编译。对频繁使用的UI元素图像进行内存驻留管理。

9. 安全与权限规范

9.1 操作权限控制

系统应区分不同级别的操作权限：
- 普通输入操作：无需特殊授权
- 系统级操作（如关机、文件删除）：需显式确认或密码验证

9.2 数据隐私保护

截图与日志中可能包含敏感信息，须支持：
- 敏感区域打码功能
- 日志脱敏选项
- 本地存储加密

10. 测试与验证标准

10.1 单元测试覆盖

所有核心模块必须具备单元测试，覆盖率不低于85%，重点包括：
- 动作执行正确性
- 视觉识别准确率
- 异常处理路径完整性

10.2 场景回归测试

建立典型应用场景测试集，定期验证跨版本兼容性，包括但不限于：
- 不同分辨率适配测试
- 多语言界面识别测试
- 界面布局变更容错测试

11. 附录：术语表

- 宏（Macro）：一系列自动化操作的有序集合
- 视觉锚点（Visual Anchor）：用于定位的稳定UI元素图像
- 置信度（Confidence）：图像匹配或OCR识别的结果可信程度
- 闭环控制（Closed-loop Control）：基于反馈调整执行行为的机制

12. 结语

本规范为桌面自动化宏执行系统的开发与集成提供了统一的技术指导。各实现方应在遵循本规范的基础上，持续优化算法性能与用户体验，推动系统向智能化、自适应方向发展。后续版本将根据实际应用反馈进行迭代更新。